#!/bin/bash
probedir=/home/chprobe
# crontab
echo "SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed" > /etc/crontab
echo "# */6  *  *  *  * root /home/chprobe/./udp_iperf3_client.sh > /dev/null"  >> /etc/crontab
echo "# */5  *  *  *  * root /home/chprobe/./udp_iperf3_client_reversed.sh > /dev/null"  >> /etc/crontab
echo "*/16 *  *  *  * root /home/chprobe/./tcp_iperf3_client.sh > /dev/null" >> /etc/crontab
echo "*/15 *  *  *  * root /home/chprobe/./tcp_iperf3_client_reversed.sh > /dev/null" >> /etc/crontab
echo "*/30 *  *  *  * root /home/chprobe/./upnpc-probe.sh > /dev/null" >> /etc/crontab
echo "*/30 *  *  *  * root /home/chprobe/./probemanager managerupdate > /dev/null" >> /etc/crontab
echo "*/60 *  *  *  * root /home/chprobe/./probemanager update > /dev/null" >> /etc/crontab
echo "5 7  *  *  7    root tar cvfz /root/backups/chprobe_backup-\$(date +\"%d%m%y\"-\"%H%M\" | tr -d '-').tgz /home/chprobe > /dev/null" >> /etc/crontab
echo "*/20 *  *  *  * root /home/chprobe/./smokeslave_fakepost > /dev/null" >> /etc/crontab
echo "*/2  *  *  *  * root /home/chprobe/./icmp_chprobe 100 1 54 ping.sunet.se >> /dev/null" >> /etc/crontab
echo "*/2  *  *  *  * root /home/chprobe/./icmp_chprobe 100 1 1800 sunet.se >> /dev/null" >> /etc/crontab
echo "*/2  *  *  *  * root /home/chprobe/./icmp_chprobe 100 0.5 54 ping.sunet.se >> /dev/null" >> /etc/crontab
echo "*/15 *  *  *  * root /home/chprobe/./bbk_chprobe > /dev/null" >> /etc/crontab

# rc.local
echo "Installing probe rc.local and syslog"
echo "#!/bin/bash
# CHPROBE RC.LOCAL MOD" > /etc/rc.local
echo "touch /var/lock/subsys/local" >> /etc/rc.local
echo "/root/./fw-rules"                         >> /etc/rc.local
echo "/home/chprobe/./smoke-slave"              >> /etc/rc.local
echo "sleep 15;/home/chprobe/./probemanager managerupdate;sleep 5;/home/chprobe/./probemanager update"             >> /etc/rc.local
echo "/home/chprobe/./upnpc-probe.sh" >> /etc/rc.local
# echo "# darkstat -i enp0s25 -p 35631 --syslog"    >> /etc/rc.local
mv $probedir/chprobe_syslog.conf /etc/rsyslog.d/
chmod +x /etc/rc.d/rc.local

# logrotate
echo "# CREATED BY CHPROBE SCRIPT" > /etc/logrotate.d/chprobe
echo "/var/log/iperf*.log" >> /etc/logrotate.d/chprobe
echo "/var/log/chprobe*.log" >> /etc/logrotate.d/chprobe
echo "{" >> /etc/logrotate.d/chprobe
echo "weekly" >> /etc/logrotate.d/chprobe
echo "rotate 10" >> /etc/logrotate.d/chprobe
echo "size 500K" >> /etc/logrotate.d/chprobe
echo "delaycompress" >> /etc/logrotate.d/chprobe
echo "}" >> /etc/logrotate.d/chprobe
echo "/var/log/chprobe_wanip.txt {" >> /etc/logrotate.d/chprobe
echo "daily" >> /etc/logrotate.d/chprobe
echo "rotate 0" >> /etc/logrotate.d/chprobe
echo "size 200" >> /etc/logrotate.d/chprobe
echo "}" >> /etc/logrotate.d/chprobe

sleep 1
systemctl restart crond
systemctl restart rsyslog
/usr/bin/bash /etc/cron.daily/logrotate
echo "Mission complete."
