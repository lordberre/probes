#!/bin/bash
# Version 2.0
probedir=/home/chprobe

# Check IPv6 connectivity
echo "Checking IPv6 connectivity, stay tuned..." &&

# In case ping6 returns errors we assume IPv6 isn't working
ping6 -q -c 1 2a00:1450:400f:802::2003
if [ $? -ge 2 ]; then echo "We don't have IPv6 connectivity (error returned: $?)" && ipmode=ipv4
	else

	# No errors returned at least, let's see if we actually have connectivity
	noconnectivity="$(ping6 -q -c 10 2a00:1450:400f:802::2003 | egrep '100%' | wc -l)"
	if [ $noconnectivity -ge 1 ]; then echo "We don't have IPv6 connectivity" && ipmode=ipv4
       else echo "We have IPv6 connectivity" && ipmode=dualstack
       fi;fi

# crontab IPv4
echo "SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root

# For details see man 4 crontabs

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
*/6  *  *  *  * root /home/chprobe/./udp_iperf3_client_merged.sh -us &> /dev/null
*/5  *  *  *  * root /home/chprobe/./udp_iperf3_client_merged.sh -ds &> /dev/null
*/16 *  *  *  * root /home/chprobe/./tcp_iperf3_client.sh &> /dev/null
*/15 *  *  *  * root /home/chprobe/./tcp_iperf3_client_reversed.sh &> /dev/null
*/30 *  *  *  * root /home/chprobe/./upnpc-probe.sh > /dev/null
*/30 *  *  *  * root /home/chprobe/./probemanager managerupdate &> /dev/null
*/60 *  *  *  * root /home/chprobe/./probemanager update &> /dev/null
5 7  *  *  7    root tar cvfz /root/backups/chprobe_backup-\$(date +\"%d%m%y\"-\"%H%M\" | tr -d '-').tgz /home/chprobe &> /dev/null
*/20 *  *  *  * root /home/chprobe/./smokeslave_fakepost > /dev/null
*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v4 100 1 54 ping.sunet.se &> /dev/null
*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v4 100 1 1800 sunet.se &> /dev/null
*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v4 100 0.5 54 ping.sunet.se &> /dev/null
*/15 *  *  *  * root /home/chprobe/./bbk_chprobe -4 -g &> /dev/null
*/12 * * * * root /home/chprobe/./multi_chprobe -w 3 200 30 http://google.se &> /dev/null
*/2 * * * * root /home/chprobe/./multi_chprobe -d 83.255.255.2 sunet.se 4 &> /dev/null
*/2 * * * * root /home/chprobe/./multi_chprobe -e www.facebook.com 4 &> /dev/null" > /etc/crontab

if [ $ipmode = "dualstack" ]; then
# When IPv6 is available also add these tests
echo "*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v6 100 1 54 ping.sunet.se &> /dev/null
*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v6 100 1 1800 sunet.se &> /dev/null
*/2  *  *  *  * root /home/chprobe/./icmp_chprobe -v6 100 0.5 54 ping.sunet.se &> /dev/null
*/16 *  *  *  * root /home/chprobe/./bbk_chprobe -6 -g &> /dev/null
*/2 * * * * root /home/chprobe/./multi_chprobe -d 2a04:ae3a:ae3a::1 sunet.se 6 &> /dev/null
*/2 * * * * root /home/chprobe/./multi_chprobe -e www.facebook.com 6 &> /dev/null" >> /etc/crontab
fi

# rc.local
echo "Installing probe rc.local and syslog"
echo "#!/bin/bash
# CHPROBE RC.LOCAL MOD
touch /var/lock/subsys/local
/root/./fw-rules
/home/chprobe/./smoke-slave
/home/chprobe/./probemanager managerupdate && /home/chprobe/./probemanager update
/home/chprobe/./upnpc-probe.sh" > /etc/rc.local
mv $probedir/chprobe_syslog.conf /etc/rsyslog.d/
chmod +x /etc/rc.d/rc.local

# logrotate
echo "# CREATED BY CHPROBE SCRIPT
/var/log/iperf*.log
/var/log/chprobe*.log
{
weekly
rotate 10
size 500K
delaycompress
}
/var/log/chprobe_wanip.txt {
daily
rotate 0
size 200
}" > /etc/logrotate.d/chprobe


sleep 1 &&
systemctl restart crond
systemctl restart rsyslog
/usr/bin/bash /etc/cron.daily/logrotate
echo "Mission complete."
